# file: postgresql/tasks/install_apt.yml
# Purpose: Install PostgreSQL from PGDG on Debian/Ubuntu in a future-proof way
# Notes:
# - No use of deprecated top-level facts (uses ansible_facts[...] instead)
# - No use of deprecated apt_key (uses a keyring + signed-by)
# - Uses HTTPS and proper keyring location to satisfy apt-secure
# - Adds default_release only when PGDG suite is available

# --- Pre-reqs for HTTPS and key handling ---
# We need CA certs, curl and gnupg to fetch and dearmor the repo key.
- name: Ensure APT HTTPS/key prerequisites are present
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true
  when: ansible_facts['pkg_mgr'] == 'apt'

# --- Derive the PGDG suite from the host codename ---
# Examples: bookworm -> bookworm-pgdg, bullseye -> bullseye-pgdg, jammy -> jammy-pgdg, noble -> noble-pgdg
- name: Compute PGDG suite from distribution codename
  ansible.builtin.set_fact:
    postgresql_apt_suite: "{{ ansible_facts['distribution_release'] }}-pgdg"
  when: ansible_facts['pkg_mgr'] == 'apt'

# --- Install the PGDG key into a keyring file ---
# This avoids deprecated apt_key usage and works with newer apt-secure expectations.
- name: Install PGDG keyring (dearmor GPG key into a file)
  ansible.builtin.shell: |
    install -d -m 0755 /usr/share/postgresql-common/pgdg
    curl -fsSL {{ postgresql_apt_key_url }} \
      | gpg --dearmor -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.gpg
  args:
    creates: /usr/share/postgresql-common/pgdg/apt.postgresql.org.gpg
  when: ansible_facts['pkg_mgr'] == 'apt'

# --- Add the PGDG APT repository (HTTPS + signed-by) ---
# We explicitly build the repo line to ensure the correct suite and signed-by usage.
- name: Add PGDG APT repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.gpg]
      {{ postgresql_apt_repo_base }}
      {{ postgresql_apt_suite }} main
    filename: pgdg
    state: present
  when:
    - ansible_facts['pkg_mgr'] == 'apt'
    - (postgresql_install_repository | default(true)) | bool

# --- Optional pinning (preferences) ---
- name: Add APT preferences for PGDG (pinning)
  ansible.builtin.template:
    src: etc_apt_preferences.d_apt_postgresql_org_pub_repos_apt.pref.j2
    dest: /etc/apt/preferences.d/apt_postgresql_org_pub_repos_apt.pref
  when:
    # cast to int, compare => boolean
    - (postgresql_apt_pin_priority | default(0) | int) > 0
    - (postgresql_install_repository | default(true)) | bool

# --- Ensure role-level APT dependencies are present ---
# This is where you can ensure build or runtime deps required before installing PostgreSQL.
- name: Ensure role APT dependencies are installed
  ansible.builtin.apt:
    name: "{{ postgresql_apt_dependencies | default([]) }}"
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
  when:
    - ansible_facts['pkg_mgr'] == 'apt'
    - (postgresql_apt_dependencies | default([])) | length > 0

# --- Install PostgreSQL packages from PGDG ---
# Use default_release only if we know the suite; this avoids "invalid APT::Default-Release" errors.
- name: Install PostgreSQL server/client/contrib
  ansible.builtin.apt:
    name:
      - "postgresql-{{ postgresql_version }}"
      - "postgresql-client-{{ postgresql_version }}"
      - "postgresql-contrib-{{ postgresql_version }}"
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
    default_release: >-
      {{ postgresql_default_release
         | default(postgresql_apt_suite | default(omit)) }}
  environment: "{{ postgresql_env | default({}) }}"
  when: ansible_facts['pkg_mgr'] == 'apt'

# --- Optional: install pgtune from PGDG ---
# Only if your role enables pgtune.
- name: Install pgtune
  ansible.builtin.apt:
    name: pgtune
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
  environment: "{{ postgresql_env | default({}) }}"
  when:
    - ansible_facts['pkg_mgr'] == 'apt'
    - (postgresql_pgtune | default(false)) | bool
