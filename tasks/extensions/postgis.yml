# file: postgresql/tasks/extensions/postgis.yml
# Purpose: Install PostGIS dependencies per OS family, future-proof (no deprecated patterns)

# Load distro-specific variables (e.g., vars/noble.yml, vars/jammy.yml, vars/bullseye.yml)
- name: Load distro-specific variables for PostGIS
  ansible.builtin.include_vars:
    file: "{{ item }}"
  loop: "{{ query('first_found', params, errors='ignore', wantlist=True) }}"
  vars:
    params:
      files:
        - "{{ ansible_facts['distribution_release'] }}.yml"
        - "empty.yml"
      paths:
        - "{{ role_path }}/vars"

# Debian/Ubuntu: install PostGIS deps via apt
- name: PostgreSQL | Extensions | Ensure PostGIS deps are installed | Debian/Ubuntu
  ansible.builtin.apt:
    name: "{{ postgresql_ext_postgis_deps }}"
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
  when: ansible_facts['os_family'] == 'Debian'
  notify:
    - restart postgresql

# RHEL-like (non-Fedora) using yum
- name: PostgreSQL | Extensions | Ensure PostGIS deps are installed | RHEL (yum)
  ansible.builtin.yum:
    name: "{{ postgresql_ext_postgis_deps }}"
    state: present
    update_cache: true
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - ansible_facts['pkg_mgr'] == 'yum'
    - ansible_facts['distribution'] != 'Fedora'
  notify:
    - restart postgresql

# Fedora using dnf
- name: PostgreSQL | Extensions | Ensure PostGIS deps are installed | Fedora (dnf)
  ansible.builtin.dnf:
    name: "{{ postgresql_ext_postgis_deps }}"
    state: present
  when:
    - ansible_facts['pkg_mgr'] == 'dnf'
    - ansible_facts['distribution'] == 'Fedora'
  notify:
    - restart postgresql
